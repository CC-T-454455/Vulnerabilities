# Uncaught Exception Vulnerability Leading to DoS in FastapiAdmin

> **Software and Affected Version:** [FastapiAdmin](https://github.com/fastapiadmin/FastapiAdmin) â‰¤ 2.2.0

## Vulnerability Files

-   `/backend/app/plugin/module_task/job/controller.py`
-   `/backend/app/plugin/module_task/job/service.py`
-   `/backend/app/plugin/module_task/job/tools/ap_scheduler.py`

## Description

An uncaught exception vulnerability exists in [FastapiAdmin](https://github.com/fastapiadmin/FastapiAdmin) â‰¤ 2.2.0 within the `/api/v1/application/job/update/{id}` endpoint, where the `func` field lacks proper validation before being persisted to the database. When the application restarts, the `init_system_scheduler()` method attempts to reload all scheduled tasks and calls `add_job()`, which uses `rsplit(".", 1)` to parse the `func` field into module path and function name. If the `func` field does not contain a dot separator, the `rsplit()` operation fails to unpack into two variables, triggering a `ValueError` that is not caught by the existing exception handlers. This unhandled exception causes the application initialization to fail completely, preventing the server from starting. As a result, authenticated attackers with the `module_task:job:update` permission can cause a Denial of Service (DoS) by manipulating the `func` field of scheduled tasks. Mitigation requires implementing input validation on the `func` field to ensure it contains valid module paths, adding proper exception handling in the task initialization process, and validating task configurations before persisting them to the database.

## Code Analysis

In `/backend/app/plugin/module_application/job/controller.py`:

```py
@JobRouter.put(
    "/update/{id}",
    summary="ä¿®æ”¹å®šæ—¶ä»»åŠ¡",
    description="ä¿®æ”¹å®šæ—¶ä»»åŠ¡",
    response_model=ResponseSchema[JobOutSchema],
)
async def update_obj_controller(
    data: JobUpdateSchema,
    id: Annotated[int, Path(description="å®šæ—¶ä»»åŠ¡ID")],
    auth: Annotated[AuthSchema, Depends(AuthPermission(["module_task:job:update"]))],
) -> JSONResponse:
    """
    ä¿®æ”¹å®šæ—¶ä»»åŠ¡

    å‚æ•°:
    - data (JobUpdateSchema): æ›´æ–°å‚æ•°æ¨¡å‹
    - id (int): å®šæ—¶ä»»åŠ¡ID
    - auth (AuthSchema): è®¤è¯ä¿¡æ¯æ¨¡å‹

    è¿”å›:
    - JSONResponse: åŒ…å«ä¿®æ”¹å®šæ—¶ä»»åŠ¡ç»“æœçš„JSONå“åº”
    """
    result_dict = await JobService.update_job_service(auth=auth, id=id, data=data)
    log.info(f"ä¿®æ”¹å®šæ—¶ä»»åŠ¡æˆåŠŸ: {result_dict}")
    return SuccessResponse(data=result_dict, msg="ä¿®æ”¹å®šæ—¶ä»»åŠ¡æˆåŠŸ")
```

In `/backend/app/plugin/module_application/job/service.py`:

```py
class JobService:

    # ...

    @classmethod
    async def update_job_service(cls, auth: AuthSchema, id: int, data: JobUpdateSchema) -> dict:
        """
        æ›´æ–°å®šæ—¶ä»»åŠ¡

        å‚æ•°:
        - auth (AuthSchema): è®¤è¯ä¿¡æ¯æ¨¡å‹
        - id (int): å®šæ—¶ä»»åŠ¡ID
        - data (JobUpdateSchema): å®šæ—¶ä»»åŠ¡æ›´æ–°æ¨¡å‹

        è¿”å›:
        - dict: å®šæ—¶ä»»åŠ¡è¯¦æƒ…å­—å…¸
        """
        exist_obj = await JobCRUD(auth).get_obj_by_id_crud(id=id)
        if not exist_obj:
            raise CustomException(msg="æ›´æ–°å¤±è´¥ï¼Œè¯¥å®šæ—¶ä»»åŠ¡ä¸å­˜åœ¨")
        if (
            data.trigger == "cron"
            and data.trigger_args
            and not CronUtil.validate_cron_expression(data.trigger_args)
        ):
            raise CustomException(msg=f"æ–°å¢å®šæ—¶ä»»åŠ¡{data.name}å¤±è´¥, Cronè¡¨è¾¾å¼ä¸æ­£ç¡®")
        obj = await JobCRUD(auth).update_obj_crud(id=id, data=data)
        if not obj:
            raise CustomException(msg="æ›´æ–°å¤±è´¥ï¼Œè¯¥æ•°æ®å®šæ—¶ä»»åŠ¡ä¸å­˜åœ¨")
        SchedulerUtil().modify_job(job_id=obj.id)
        return JobOutSchema.model_validate(obj).model_dump()
```

In `/backend/app/plugin/module_application/job/tools/ap_scheduler.py`:

```py
class SchedulerUtil:

    # ...

    @classmethod
    async def init_system_scheduler(cls, redis: Redis) -> None:
        """
        åº”ç”¨å¯åŠ¨æ—¶åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡ã€‚

        è¿”å›:
        - None
        """
        # å»¶è¿Ÿå¯¼å…¥é¿å…å¾ªç¯å¯¼å…¥
        from app.api.v1.module_system.auth.schema import AuthSchema
        from app.plugin.module_task.job.crud import JobCRUD

        log.info("ğŸ” å¼€å§‹å¯åŠ¨å®šæ—¶ä»»åŠ¡...")
        # ä¿å­˜Redisè¿æ¥åˆ°ç±»å˜é‡
        cls.redis_instance = redis
        # å¯åŠ¨è°ƒåº¦å™¨
        scheduler.start()
        # æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        scheduler.add_listener(cls.scheduler_event_listener, EVENT_ALL)
        async with async_db_session() as session:
            async with session.begin():
                auth = AuthSchema(db=session)
                job_list = await JobCRUD(auth).get_obj_list_crud()
                # ä½¿ç”¨Redisé”ç¡®ä¿åªæœ‰ä¸€ä¸ªå®ä¾‹æ‰§è¡Œä»»åŠ¡åˆå§‹åŒ–
                redis_client = RedisCURD(redis)
                lock_key = f"{RedisInitKeyConfig.APSCHEDULER_LOCK_KEY.key}:job"
                # å°è¯•è·å–é”ï¼Œè¿‡æœŸæ—¶é—´10ç§’
                lock_acquired, lock_value = await redis_client.lock(lock_key, 10)
                if lock_acquired:
                    try:
                        for item in job_list:
                            # æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å·²ç»å­˜åœ¨
                            existing_job = cls.get_job(job_id=item.id)
                            if existing_job:
                                cls.remove_job(job_id=item.id)  # åˆ é™¤æ—§ä»»åŠ¡
                            # æ·»åŠ æ–°ä»»åŠ¡
                            cls.add_job(item)
                            # æ ¹æ®æ•°æ®åº“ä¸­ä¿å­˜çš„çŠ¶æ€æ¥è®¾ç½®ä»»åŠ¡çŠ¶æ€
                            if item.status == "1":
                                # å¦‚æœä»»åŠ¡çŠ¶æ€ä¸ºæš‚åœï¼Œåˆ™ç«‹å³æš‚åœåˆšæ·»åŠ çš„ä»»åŠ¡
                                cls.pause_job(job_id=item.id)
                    finally:
                        # é‡Šæ”¾é”
                        await redis_client.unlock(lock_key, lock_value)
                else:
                    # ç­‰å¾…å…¶ä»–å®ä¾‹å®Œæˆåˆå§‹åŒ–
                    import asyncio

                    await asyncio.sleep(2)
                    log.info("âœ…ï¸ å®šæ—¶ä»»åŠ¡å·²ç”±å…¶ä»–å®ä¾‹åˆå§‹åŒ–å®Œæˆ")

    # ...

    @classmethod
    def add_job(cls, job_info: JobModel) -> Job:
        """
        æ ¹æ®ä»»åŠ¡é…ç½®åˆ›å»ºå¹¶æ·»åŠ è°ƒåº¦ä»»åŠ¡ã€‚

        å‚æ•°:
        - job_info (JobModel): ä»»åŠ¡å¯¹è±¡ä¿¡æ¯ï¼ˆåŒ…å«è§¦å‘å™¨ã€å‡½æ•°ã€å‚æ•°ç­‰ï¼‰ã€‚

        è¿”å›:
        - Job: æ–°å¢çš„ä»»åŠ¡å¯¹è±¡ã€‚
        """
        # åŠ¨æ€å¯¼å…¥æ¨¡å—
        # 1. è§£æè°ƒç”¨ç›®æ ‡
        module_path, func_name = str(job_info.func).rsplit(".", 1)
        module_path = "app.plugin.module_task.job.function_task." + module_path
        try:
            module = importlib.import_module(module_path)
            job_func = getattr(module, func_name)

            # ...

            log.info(f"ä»»åŠ¡ {job_info.id} æ·»åŠ åˆ° {job_info.jobstore} å­˜å‚¨å™¨æˆåŠŸ")
            return job
        except ModuleNotFoundError:
            raise ValueError(f"æœªæ‰¾åˆ°è¯¥æ¨¡å—ï¼š{module_path}")
        except AttributeError:
            raise ValueError(f"æœªæ‰¾åˆ°è¯¥æ¨¡å—ä¸‹çš„æ–¹æ³•ï¼š{func_name}")
        except Exception as e:
            raise CustomException(msg=f"æ·»åŠ ä»»åŠ¡å¤±è´¥: {e!s}")

    # ...

    @classmethod
    def modify_job(cls, job_id: str | int) -> Job:
        """
        æ›´æ–°æŒ‡å®šä»»åŠ¡çš„é…ç½®ï¼ˆè¿è¡Œä¸­çš„ä»»åŠ¡ä¸‹æ¬¡æ‰§è¡Œç”Ÿæ•ˆï¼‰ã€‚

        å‚æ•°:
        - job_id (str | int): ä»»åŠ¡IDã€‚

        è¿”å›:
        - Job: æ›´æ–°åçš„ä»»åŠ¡å¯¹è±¡ã€‚

        å¼‚å¸¸:
        - CustomException: å½“ä»»åŠ¡ä¸å­˜åœ¨æ—¶æŠ›å‡ºã€‚
        """
        query_job = cls.get_job(job_id=str(job_id))
        if not query_job:
            raise CustomException(msg=f"æœªæ‰¾åˆ°è¯¥ä»»åŠ¡ï¼š{job_id}")
        return scheduler.modify_job(job_id=str(job_id))
```

When modifying a task, no validation was performed on the `func` function. During application startup, the exception handling for `rsplit(".", 1)` was not caught during the task addition process.

## Proof of Concept

Create a normal job, with the `func` field being `scheduler_test.job`, and remember the job ID returned:

![](./assets/dos-1.png)

Modify the above task, changing the `func` field to any value that does not contain the `.` character:

![](./assets/dos-2.png)

Restarting the server failed due to an uncaught exception:

![](./assets/dos-3.png)

![](./assets/dos-4.png)
